<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch GeoJSON Data</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 400px; }
        #radiusValue { margin-left: 10px; }
    </style>
</head>
<body>
    <h1>Fetch GeoJSON Data</h1>
    <form id="geoForm">
		<select id="apiEndpoint" name="apiEndpoint">
            <option value="https://data.calgary.ca/resource/uc4c-6kbd.geojson?$where=within_circle(multipolygon," data-option="1">Rooflines</option>
            <option value="https://data.calgary.ca/resource/tfs4-3wwa.geojson?$where=within_circle(point," data-option="2">Trees</option>
            <option value="https://data.calgary.ca/resource/muzh-c9qc.geojson?$where=within_circle(point," data-option="3">Transit Stops</option>
			<option value="https://data.calgary.ca/resource/qr97-4jvx.geojson?$where=within_circle(point," data-option="4">Traffic Signals</option>
			<option value="https://data.calgary.ca/resource/u6ce-yibw.geojson?$where=within_circle(point," data-option="5">Road Signs</option>
			
			
			
        </select><br><br>
        <label for="latitude">Latitude:</label>
        <input type="number" id="latitude" name="latitude" step="any" required><br><br>
        <label for="longitude">Longitude:</label>
        <input type="number" id="longitude" name="longitude" step="any" required><br><br>
        <label for="radius">Radius (meters):</label>
        <input type="range" id="radius" name="radius" min="0" max="5000" step="100" value="800">
        <span id="radiusValue">800</span> meters<br><br>

        <button type="submit">Fetch Data</button>
    </form>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([51.0466, -114.0732], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        let marker;
        let circle;

        map.on('click', function(e) {
            const { lat, lng } = e.latlng;
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;

            if (marker) {
                marker.setLatLng(e.latlng);
            } else {
                marker = L.marker(e.latlng).addTo(map);
            }

            updateCircle(lat, lng, document.getElementById('radius').value);
        });

        document.getElementById('radius').addEventListener('input', function() {
            const radius = this.value;
            document.getElementById('radiusValue').textContent = radius;
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            if (!isNaN(lat) && !isNaN(lon)) {
                updateCircle(lat, lon, radius);
            }
        });

        function updateCircle(lat, lon, radius) {
            if (circle) {
                circle.setLatLng([lat, lon]);
                circle.setRadius(radius);
            } else {
                circle = L.circle([lat, lon], { radius: radius }).addTo(map);
            }
        }

        async function fetchData(apiEndpoint, lat, lon, radius, limit, offset, apptoken) {
            const url = `${apiEndpoint}${lat},${lon},${radius})&$limit=${limit}&$offset=${offset}&$$app_token=${apptoken}`;
            const response = await fetch(url);
            return response.json();
        }

        function saveToFile(data, filename) {
            const blob = new Blob([JSON.stringify(data)], { type: 'application/geo+json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
		
		function modifyBuildingGeojson(geojson) {
			if (geojson.type === 'FeatureCollection') {
				geojson.features.forEach(feature => {
					feature.properties = { "building": "yes" };
				});
			} else if (geojson.type === 'Feature') {
				geojson.properties = { "building": "yes" };
			}
			return geojson;
		}
		
		function sleep(ms) {
			return new Promise(resolve => setTimeout(resolve, ms));
		}

        async function main(apiEndpoint, apiOption, lat, lon, radius) {
            let offset = 0;
            const increment = 400;
			const limit = 400;
			const apptoken = 'bjDq1TelG9z0j3ngR3379N7Yu';
            const filename = 'data.geojson';

            const allFeatures = new Set();

            while (true) {
                const data = await fetchData(apiEndpoint, lat, lon, radius, limit, offset, apptoken);
                if (!data.features || data.features.length === 0) {
                    break;
                }
                data.features.forEach(feature => {
                    allFeatures.add(JSON.stringify(feature));
                });
                console.log(`Fetched ${data.features.length} features with offset ${offset}`);
                offset += increment;
				await sleep(500); // Delay each call by 500ms
            }

            const uniqueFeatures = Array.from(allFeatures).map(feature => JSON.parse(feature));
            const combinedGeojson = {
                type: "FeatureCollection",
                features: uniqueFeatures
            };

            console.log(`Total number of unique features found: ${uniqueFeatures.length}`);
			
            //Process final geojson depending on format
			console.log("Option selected", apiOption);
			switch (apiOption) {
				case 1:
					modifyBuildingGeojson(combinedGeojson);
					console.log("Processing Buildings data");
					break;
				case 2:
					console.log("Option 2 selected");
					break;
				case 3:
					console.log("Option 3 selected");
					break;
				case 4:
					console.log("Option 4 selected");
					break;
				case 5:
					console.log("Option 5 selected");
					break;
				default:
					console.log("Invalid option");
			}			
			
			saveToFile(combinedGeojson, filename);
        }

        document.getElementById('geoForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const lat = parseFloat(document.getElementById('latitude').value);
            const lon = parseFloat(document.getElementById('longitude').value);
            const radius = parseInt(document.getElementById('radius').value);
            const apiEndpoint = document.getElementById('apiEndpoint').value;
			const apiOption = parseInt(document.getElementById('apiEndpoint').selectedOptions[0].getAttribute('data-option'));
            main(apiEndpoint, apiOption, lat, lon, radius);
        });
    </script>
</body>
</html>
